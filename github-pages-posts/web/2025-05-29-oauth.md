---
layout: single
title: "[web] OAuth"
categories: web
---

생활코딩 oauth 내용 및 개인 학습 내용 추가

## OAuth

#### 하고 싶은 것

내 서비스를 통해 사용자가 가입한 타 서비스를 제어하는 것 (예. 구글 캘린더에 내용을 추가)

#### OAuth의 참여자

1. 내 서비스 => Client
2. 내 서비스를 이용하려는 사용자 => Resource Owner
3. 사용자가 가입한 타 서비스(구글, 페이스북, 카카오톡 등) => Resource Sever(데이터담당) + Authorization Server(인증담당)

#### OAuth의 최종 목표 === accessToken 발급 및 사용

- 타 서비스에서 **accessToken**을 발급받아, 내서비스에서 해당 **accessToken**으로 타서비스를 이용한다

#### accessToken의 장점

- 사용자의 ID/PW 정보를 포함하지 않음
- 해당 accessToken에 대한 권한 내용이 정해져 있음(내서비스에서 사용할 것만 권한 요청할 수 있고, 보안도 강화)

## OAuth의 단계

1. Register 단계 (client - resource server)
   1. client가 redirection uri를, resource server는 client id와 client secret을 생성해 공유하는 단계
2. Resource Owner 승인 (resource owner(user) - resource server)
   1. client가 걸어놓은 링크(resource server domain + client id + scope + redirection uri)를 통해, resource server에 resource owner가 로그인하고, 권한 허락을 하는 단계
3. Resource Server 승인 (resource server > resource owner > client)
   1. resource owner의 권한 허락 요청에 대해 resource server는 authorization code와 함께 redirection uri로 응답함.
   2. resouce owner는 redirection uri(client)로 redirection 하게 되며, 이때 authorization code도 함께 요청에 넣어 보내는 단계
4. accessToken 발급 (client - resource server)
   1. client가 resource owner를 통해 전달받은 authorization code를 포함해 clientId, clientSecret 등으로 Resource server에 해당 유저에 대한 accessToken 발급을 요청하고, resource server의 응답에 넣어준 accessToken을 client 내부적으로 보관하는 단계
   2. 이 단계까지 끝나면, resource server안에는 클라이언트 > 유저 > accessToken 및 허용 권한 내용 이 들어가 있는 상태임
5. API 호출 (client - resource server)
   1. client가 accessToken을 통해 resource server에 해당 유저에 대한 타서비스 기능을 이용하는 단계
6. Refresh Token (client - resource server)
   1. accessToken이 유효기간이 끝났을 때, 발급시 같이 전달받은 refreshToken을 통해 다시 accessToken을 발급받는 단계

#### Register 단계

내 서비스 (client)가 사전에 타서비스(Resource Server)에 미리 등록해 놓는 과정

- 서비스마다 등록 방법이 다르나, 아래 내용은 공통적으로 들어감 (구글은 OAuth Client 도 제공하지만, API 키 방법도 제공하는듯)
  - Client ID : 내 서비스를 식별하는 ID
  - Client Secret : 내 서비스에 대한 비밀번호 (노출되면 안됨)
  - Authorized redirect URIs : Resource Server가 인증 과정에서 Authorization Code를 전달하게 되는데 그걸 받을 URI이고, 이 URI에서 요청이 오는게 아닐 경우, Resource Server는 해당 요청을 무시
- 등록 과정이 끝났을 때, Resource Server와 Client는 Client ID, Client Secret, Authoriazation redirect URI를 알게되는거임.
- redirect_uri (예. `https://client/callback`)에 대한 페이지는 내 서비스에서 구현하고 있어야함.

#### Resource Owner 승인

타서비스(Resource Server)가 제공하는 기능 중 내 서비스(Client)가 사용하려는 기능을 사용자(Resource Owner)에게 승인을 받아야함.

- 내 서비스(Client)는 사용자(Resource Owner)에게 ‘Login with google'과 같은 버튼을 보여줌.
- 그 버튼의 내용은 아래와 같은 주소에 링크를 걸어둔 것임
  - `https://resource.server/?client_id=1&scope=B,C&redirect_uri=https://client/callback`
  - https 프로토콜을 사용해 `resource.server` 도메인에 접속(요청)을 하는데
  - client_id (내 서비스의 id)와 scope(해당 서비스에서 사용할 기능, 예) 로그인), redirect_uri (내 서비스가 미리 등록한 redirect_uri)을 넘겨줌
- 위에껄 다시 말하면, 내가 어떤 기능을 쓸 것인지 저 url를 통해 정한다는 말인것 같음. (추가적인 로직을 쓰는 서비스도 있겠지만..)
- 요청을 받은 타서비스(resource server)는 유저가 로그인이 안되어 있으면, 로그인을 하라는 화면을 사용자에게 띄어줌
- 유저가 로그인을 하면, 타서비스(resource server)는 client id, redirect_url 확인하고, 제대로된 값이라면, 사용자(resource owner)에게 이 기능을 사용하게 할 것인가 하는 화면을 유저에게 띄어줌.
- 유저가 허용 버튼을 누르면, Resource Server는 해당 UserId가 scope B,C에 대한 동의를 했다라는 것을 서버에 기록함.
- 이 과정이 끝나면, Resource Server는 client Id, Client Secret, redirect URL + 특정 user id, 해당 user id가 동의한 scope 정보를 알게됨

#### Resource Server 승인

그러고 나면 해당 user id에 대한 accessToken을 바로 발급하는 것이 아니라 한 번의 추가적인 검증 단계를 더 거침.

- 위 과정에서 유저가 권한 허용 버튼을 누르면(서버에 허용 요청), esource Server는 해당 user에 대한 임시 비밀번호인 Authorization code를 만들고, http 헤더에 redirection 할 주소와 함께, authorization code를 함께 넣어 응답함.
- 응답을 받은 사용자(Resource Owner)는 redirection uri(내 서비스의 콜백 주소인)로 리디렉션 하게되고, authorization code도 함께 넣어 요청함. (== 내 서비스로 접속하면서 authorization code를 전달하는 요청을 하게되는것임 == 내 서비스는 authorization code를 알게됨)
- 그런다음 내 서비스(Client)는 타서비스(Resource Server)에 직접 요청을 하게되고, 그 내용은 아래와 같음. `https://resource.sever/token?grant_type=authoriazation_code&code=xxx&redirect_uri=https://client/callback&client_id=1&client_secret=xxx`
  - https 프로토콜을 사용해, `resource.server/token`에 요청을 하는데,
  - grant_type + authorization_code + redirect_uri, client_id, client_secret을 같이 넘겨줌
  - grant_type의 경우, authorization_cdoe 방법 말고 다른 방법도 있어서 내 서비스가 인증하려는 방법이 authorization code를 사용하려는 방법이다라는걸 알려주는 부분임.
- Resource Server는 넘어온 정보를 살펴보고 자기가 가지고 있는 내용(clientId, clientSecret, authorization code등)과 일치하면, 다음 단계인 `accessToken 발급`을 진행함

#### accessToken 발급

- 확인을 마친 Resource Server는 먼저 더이상 사용하지 않는 해당 유저에 대한 authorization code 값을 지워버림. (다음에 다시 인증을 하지 않기 위해서!)
- 그리고 해당 client에 안에 해당 user에 대한 accessToken을 만듦
- 그리고 Clent에 대한 응답에 accessToken을 넣어 전달함.
- 그럼 Client는 해당 accessToken을 내부적으로 어딘가에 저장해둠
- 이제는 앞으로 내서비스(client)는 accessToken을 가지고 타서비스(Resource Server)에 직접 이거 해주세요. 저거해주세요. 요청하게 될꺼임.
- resource server 입장에서 accessToken은 userId와 묶여 있고, userID아래에는 user가 허용한 기능 권한 내용이 들어있는 상태여서 client 의 요청 중 허용한 기능이 아닌것도 판별이 가능함.

#### API 호출

accessToken을 활용해서 내서비스(client)에서 타서비스(resource server)에 요청하는 단계

- 타서비스(resource server)가 각 기능을 쓰려면 이렇게 써야해요. 하고 정해놓은게 API임.
- 예) 구글 캘린더 API라고 검색해보면 여러가지 쓰는 방법이 나옴 (url + method 형태로 구성됨)
- 위 API에 해당 url + method로 접근할 때, accessToken을 함께 넣어 요청함.
- 구글 API의 경우, accessToken을 쿼리로 넣거나, http의 헤더에 넣는 방식이 있으며 후자를 보안상 더 선호함.

#### Refresh Token

accessToken은 보통 수명이 있음. 이걸 refresh 해줘야함.

- 클라이언트가 직접 resource server에 사용자를 거치지 않고 token을 refresh 할 수 있음. (어떤 시스템은보안상 이걸 못하게하고, 직접 사용자가 다시 로그인하고 하는 과정을 거치도록 하는 것도 있음)
- Resource Server(Authorization Server)가 보통 accessToken 발급시 refreshToken도 발급함.
- AccessToken으로 Resource Server에 요청시, Invalid Token Error 응답이 오면, 우리가 보관중이던 Refresh Token으로 authorization Server에 요청하여 다시 Access Token과 경우에 따라 새로운 Refresh Token을 전달 받음

#### 위의 OAuth는 웹에 관한 내용이고, redirection uri도 필요한데 모바일 앱에서는 이걸 어떻게 구현하는가?

- 주로 웹브라우저를 띄워 인증을 수행하고, 인증 후(accessToken을 얻은 후를 말하는듯)에는 다시 앱으로 돌아오는 방식
- redirection URI 의 처리 (주로 아래 2가지 방법이 주로 사용됨)
  - Custom URI Scheme 사용 방법 : 모바일 앱은 자체적으로 정의된 custom uri shceme을 가질 수 있고, 운영체제에서 이걸 감지하여 해당 uri을 처리할 수 있는 앱을 실행하거나 실행중인 앱으로 uri를 전달하는 방식 실제 웹의 uri는 아니고, 운영체제 안에서 앱에 대한 uri를 말하는 것 같음. expo가 이걸로 expo 앱을 실행하는 것도 같음. (다른 앱과 충돌할 가능성도 있음.)
  - Universal Links / Android app Links 사용 방법 : 웹 링크를 마치 앱 링크처럼 동작하게 하는 기술(?)
    - 앱과 연결될 실제 웹의 url을 등록 > 인증서버는 실제 웹의 url로 리디렉션하게 설정 > 운영체제가 이 웹 url이 특정 앱과 연결되어 있음을 인지하고, 자동으로 앱을 실행시키거나 앱 내에서 url을 처리하도록 전달함
    - 앱과 실제 웹의 url이 연결된걸 운영체제가 어떻게 알 수 있나? 간략하게 말하면 앱을 만들 때, 해당 앱에 대한 실제 웹 url이 설정파일에 들어가고, 위 link 기능을 사용할꺼야 라는 내용이 들어가게함. 그럼, 운영체제가 웹브라우저에서 특정 url에 접근할 때, 특정 앱을 실행할 수 있게 됨
